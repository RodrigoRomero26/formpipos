<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Request</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slim-select@2.8.2/dist/slimselect.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Gabarito', cursive;
            background-image: url('img/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 16px;
            scrollbar-width: thin;
            scrollbar-color: #ec4078 rgba(248, 187, 208, 0.2);
        }

        /* Custom Scrollbar Styles */
        /* Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(248, 187, 208, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #f8bbd0 0%, #ec4078 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
        }

        /* Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: #ec4078 rgba(248, 187, 208, 0.2);
        }

        /* Custom scrollbar for textareas and scrollable elements */
        textarea::-webkit-scrollbar,
        .ss-content::-webkit-scrollbar {
            width: 10px;
        }

        textarea::-webkit-scrollbar-track,
        .ss-content::-webkit-scrollbar-track {
            background: rgba(248, 187, 208, 0.15);
            border-radius: 8px;
        }

        textarea::-webkit-scrollbar-thumb,
        .ss-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #f8bbd0 0%, #ec4078 100%);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        textarea::-webkit-scrollbar-thumb:hover,
        .ss-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
        }

        .hearts-decoration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            font-size: 24px;
            pointer-events: none;
            opacity: 0.1;
            letter-spacing: 15px;
            color: #ec4078;
            overflow: hidden;
            white-space: nowrap;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(236, 64, 122, 0.2);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 28px;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .header p {
            color: #d81b60;
            font-size: 12px;
            font-weight: 500;
        }

        .success-message {
            display: none;
            padding: 16px;
            background: #c8e6c9;
            color: #2e7d32;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 24px;
        }

        .success-message.show {
            display: block;
        }

        .error-message {
            display: none;
            padding: 16px;
            background: #ffcdd2;
            color: #c62828;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 24px;
        }

        .error-message.show {
            display: block;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contact-inputs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .contact-inputs select {
            flex: 0 0 auto;
            min-width: 110px;
        }

        .contact-inputs input {
            flex: 1;
            min-width: 140px;
        }

        label {
            color: #c2185b;
            font-weight: 600;
            font-size: 13px;
        }

        .required {
            color: #ec4078;
        }

        .optional {
            color: #999;
            font-size: 11px;
            margin-left: 5px;
            font-weight: 400;
        }

        .file-limit {
            color: #999;
            font-size: 11px;
            margin-left: 5px;
            font-weight: 400;
        }

        input[type="text"],
        input[type="email"],
        input[type="file"],
        select,
        textarea {
            padding: 11px 14px;
            border: 2px solid #f8bbd0;
            border-radius: 20px;
            font-family: 'Gabarito', cursive;
            font-size: 13px;
            transition: all 0.3s ease;
            background: white;
        }

        textarea {
            resize: none;
            min-height: 90px;
            font-size: 13px;
            overflow-y: hidden;
            line-height: 1.5;
        }

        .char-counter {
            text-align: right;
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            font-weight: 500;
            font-family: 'Gabarito', cursive;
        }

        .char-counter span {
            color: #c2185b;
            font-weight: 600;
        }

        .char-counter.warning span {
            color: #ff9800;
        }

        .char-counter.danger span {
            color: #f44336;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="file"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #ec4078;
            box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.1);
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ec4078' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
            padding-right: 32px;
            cursor: pointer;
        }

        /* Slim Select Custom Styles */
        .ss-main {
            border: 2px solid #f8bbd0 !important;
            border-radius: 20px !important;
            padding: 11px 14px !important;
            background: white !important;
            font-family: 'Gabarito', cursive !important;
            font-size: 13px !important;
            min-height: auto !important;
            transition: all 0.3s ease !important;
        }

        .ss-main:focus {
            outline: none !important;
            border-color: #ec4078 !important;
            box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.1) !important;
        }

        .ss-main:hover {
            border-color: #f48fb1 !important;
        }

        .ss-main .ss-single {
            color: #c2185b !important;
            font-weight: 500 !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .ss-main .ss-arrow {
            margin: 0 !important;
            width: 18px !important;
            height: 18px !important;
        }

        .ss-main .ss-arrow path {
            stroke: #ec4078 !important;
            stroke-width: 2 !important;
        }

        .ss-content {
            border: 2px solid #f8bbd0 !important;
            border-radius: 20px !important;
            background: white !important;
            box-shadow: 0 8px 32px rgba(236, 64, 122, 0.2) !important;
            overflow: hidden !important;
            margin-top: 4px !important;
        }

        .ss-content .ss-search input {
            border: 2px solid #f8bbd0 !important;
            border-radius: 15px !important;
            padding: 8px 12px !important;
            font-family: 'Gabarito', cursive !important;
            font-size: 13px !important;
            color: #c2185b !important;
        }

        .ss-content .ss-search input:focus {
            outline: none !important;
            border-color: #ec4078 !important;
            box-shadow: 0 0 0 3px rgba(236, 64, 122, 0.1) !important;
        }

        .ss-content .ss-list {
            max-height: 300px !important;
        }

        .ss-content .ss-list .ss-option {
            padding: 12px 14px !important;
            font-family: 'Gabarito', cursive !important;
            font-size: 13px !important;
            color: #c2185b !important;
            transition: all 0.2s ease !important;
        }

        .ss-content .ss-list .ss-option:hover {
            background: #fce4ec !important;
            color: #ec4078 !important;
        }

        .ss-content .ss-list .ss-option.ss-selected {
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%) !important;
            color: white !important;
        }

        .ss-content .ss-list .ss-option.ss-disabled {
            color: #999 !important;
            background: #f5f5f5 !important;
        }

        input[type="file"] {
            cursor: pointer;
            padding: 10px 12px;
        }

        input[type="file"]::file-selector-button {
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Gabarito', cursive;
            font-weight: 600;
            margin-right: 8px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .file-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #f8bbd0;
        }

        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ec4078;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .buttons {
            display: flex;
            gap: 10px;
            padding-top: 12px;
            flex-direction: column;
        }

        button {
            width: 100%;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Gabarito', cursive;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .submit-btn {
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 64, 122, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 64, 122, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #f8bbd0;
            color: #c2185b;
            border-color: #ec4078;
        }

        .reset-btn:hover {
            background: #f48fb1;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 18px;
                border-radius: 24px;
            }

            .header h1 {
                font-size: 32px;
                letter-spacing: 1px;
            }

            .header p {
                font-size: 11px;
            }

            form {
                gap: 16px;
            }

            .contact-inputs {
                flex-direction: column;
            }

            .contact-inputs select,
            .contact-inputs input {
                width: 100%;
                min-width: auto;
            }

            textarea {
                min-height: 80px;
                font-size: 12px;
            }

            input[type="text"],
            input[type="email"],
            select {
                font-size: 12px;
            }

            label {
                font-size: 12px;
            }

            .buttons {
                gap: 8px;
            }

            button {
                padding: 10px 14px;
                font-size: 13px;
            }

            /* Slim Select Responsive Styles */
            .ss-main {
                font-size: 12px !important;
                padding: 10px 12px !important;
            }

            .ss-main .ss-single {
                font-size: 12px !important;
            }

            .ss-content {
                border-radius: 15px !important;
            }

            .ss-content .ss-list .ss-option {
                padding: 10px 12px !important;
                font-size: 12px !important;
            }

            .ss-content .ss-search input {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }

            .char-counter {
                font-size: 10px !important;
                margin-top: 3px !important;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 36px;
            }

            /* Slim Select Tablet Styles */
            .ss-main {
                font-size: 12.5px !important;
            }

            .ss-content .ss-list {
                max-height: 250px !important;
            }
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 16px;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 30px;
            padding: 32px 24px;
            box-shadow: 0 12px 48px rgba(236, 64, 122, 0.3);
            backdrop-filter: blur(10px);
            max-width: 400px;
            width: 100%;
            text-align: center;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.3s ease;
            border: 2px solid rgba(236, 64, 122, 0.2);
        }

        .popup-overlay.show .popup-content {
            transform: scale(1) translateY(0);
        }

        .popup-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: popupBounce 0.5s ease;
        }

        @keyframes popupBounce {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .popup-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #ec4078 0%, #ff6b9d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .popup-message {
            color: #c2185b;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.5;
        }

        .popup-success .popup-icon {
            color: #4caf50;
        }

        .popup-error .popup-icon {
            color: #f44336;
        }

        @media (max-width: 480px) {
            .popup-content {
                padding: 24px 20px;
                border-radius: 24px;
            }

            .popup-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }

            .popup-title {
                font-size: 20px;
            }

            .popup-message {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="hearts-decoration">
        ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥ ♥
    </div>

    <!-- Popup Overlay -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content" id="popupContent">
            <div class="popup-icon" id="popupIcon">✓</div>
            <div class="popup-title" id="popupTitle">¡Éxito!</div>
            <div class="popup-message" id="popupMessage">Tu solicitud ha sido enviada correctamente</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Commission Request</h1>
            <p>Submit your commission here ♥</p>
        </div>

        <div class="success-message" id="successMessage">
            Your request has been sent successfully!
        </div>

        <div class="error-message" id="errorMessage">
            Error sending the form. Please try again.
        </div>

        <form id="commissionsForm">
            <!-- Name -->
            <div class="form-group">
                <label for="nombre">
                    Name <span class="required">*</span>
                </label>
                <input type="text" id="nombre" name="nombre" required>
            </div>

            <!-- Contact Data -->
            <div class="contact-group">
                <label>
                    Contact Data <span class="required">*</span>
                </label>
                <div class="contact-inputs">
                    <select id="contactType" name="contactType" required>
                        <option value="">-- Select --</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">Twitter / X</option>
                        <option value="mail">E-Mail</option>
                    </select>
                    <input type="text" id="contactValue" name="contactValue" placeholder="Enter your contact" required>
                </div>
            </div>

            <!-- Commission Type -->
            <div class="form-group">
                <label for="tipo">
                    Commission Type <span class="required">*</span>
                </label>
                <select id="tipo" name="tipo" required>
                    <option value="">-- Select an option --</option>
                    <option value="solo-sketch">Sketch Solo - $55 USD</option>
                    <option value="couple-sketch">Sketch Couple - $85 USD</option>
                    <option value="solo-detailed">Detailed Solo - $120 USD</option>
                    <option value="couple-detailed">Detailed Couple - $170 USD</option>
                    <option value="solo-animation">Animation Solo - $250 USD</option>
                    <option value="couple-animation">Animation Couple - $450 USD</option>
                </select>
            </div>

            <!-- Pose -->
            <div class="form-group">
                <label for="pose">
                    Pose <span class="required">*</span>
                </label>
                <textarea id="pose" name="pose" placeholder="Describe the pose you want..." required maxlength="500"></textarea>
                <div class="char-counter" id="pose-counter"><span>0</span>/500</div>
            </div>

            <!-- Pose Reference Images -->
            <div class="form-group">
                <label for="pose-imagen">
                    Pose Reference Images <span class="file-limit">(max 5 images)</span>
                </label>
                <input type="file" id="pose-imagen" name="pose-imagen" accept="image/*" multiple data-max="5">
                <div class="file-preview" id="pose-preview"></div>
            </div>

            <!-- Outfit -->
            <div class="form-group">
                <label for="outfit">
                    Outfit / Details <span class="optional">(optional)</span>
                </label>
                <textarea id="outfit" name="outfit" placeholder="Describe the outfit you want..." maxlength="500"></textarea>
                <div class="char-counter" id="outfit-counter"><span>0</span>/500</div>
            </div>

            <!-- Outfit Reference Images -->
            <div class="form-group">
                <label for="outfit-imagen">
                    Outfit Reference Images <span class="optional">(optional)</span> <span class="file-limit">(max 5 images)</span>
                </label>
                <input type="file" id="outfit-imagen" name="outfit-imagen" accept="image/*" multiple data-max="5">
                <div class="file-preview" id="outfit-preview"></div>
            </div>

            <!-- References -->
            <div class="form-group">
                <label for="referencias">
                    References <span class="required">*</span>
                </label>
                <textarea id="referencias" name="referencias" placeholder="Share references, URLs, images, etc..." required maxlength="500"></textarea>
                <div class="char-counter" id="referencias-counter"><span>0</span>/500</div>
            </div>

            <!-- References Images -->
            <div class="form-group">
                <label for="referencias-imagen">
                    Reference Images <span class="file-limit">(max 5 images)</span>
                </label>
                <input type="file" id="referencias-imagen" name="referencias-imagen" accept="image/*" multiple data-max="5">
                <div class="file-preview" id="referencias-preview"></div>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="descripcion">
                    Additional Description <span class="required">*</span>
                </label>
                <textarea id="descripcion" name="descripcion" placeholder="Tell us more about your commission..." required maxlength="500"></textarea>
                <div class="char-counter" id="descripcion-counter"><span>0</span>/500</div>
            </div>

            <!-- Buttons -->
            <div class="buttons">
                <button type="submit" class="submit-btn" id="submitBtn">Send Request</button>
                <button type="reset" class="reset-btn">Clear</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/slim-select@2.8.2/dist/slimselect.min.js"></script>
    <script>
        // Initialize Slim Select for dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Check if mobile device
            const isMobile = window.innerWidth <= 768;
            
            new SlimSelect({
                select: '#contactType',
                placeholder: '-- Select --',
                allowDeselect: false,
                showSearch: !isMobile, // Disable search on mobile for better UX
                searchPlaceholder: 'Search...',
                searchText: 'No results',
                searchHighlight: true
            });
            
            new SlimSelect({
                select: '#tipo',
                placeholder: '-- Select an option --',
                allowDeselect: false,
                showSearch: !isMobile, // Disable search on mobile for better UX
                searchPlaceholder: 'Search...',
                searchText: 'No results',
                searchHighlight: true
            });
        });

        // CONFIGURACIÓN: Cambia esta URL por tu endpoint de Vercel desplegado
        const API_URL = 'https://backendteru.vercel.app/api/send-email';
        const CLOUDINARY_CONFIG_URL = 'https://backendteru.vercel.app/api/cloudinary-config';
        
        // Cloudinary configuration (will be loaded from backend)
        let CLOUDINARY_CLOUD_NAME = '';
        let CLOUDINARY_UPLOAD_PRESET = '';
        
        // Load Cloudinary config from backend on page load
        async function loadCloudinaryConfig() {
            try {
                const response = await fetch(CLOUDINARY_CONFIG_URL);
                const config = await response.json();
                CLOUDINARY_CLOUD_NAME = config.cloudName;
                CLOUDINARY_UPLOAD_PRESET = config.uploadPreset;
                if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                    console.warn('Cloudinary config not found. Please set CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET in Vercel environment variables.');
                }
            } catch (error) {
                console.error('Error loading Cloudinary config:', error);
            }
        }
        
        // Load config when page loads
        loadCloudinaryConfig();

        // Auto-resize textareas function
        function autoResizeTextarea(textarea) {
            // Reset height to auto to get the correct scrollHeight
            textarea.style.height = 'auto';
            // Set height to scrollHeight (content height)
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Update character counter
        function updateCharCounter(textarea, counterId) {
            const counter = document.getElementById(counterId);
            const currentLength = textarea.value.length;
            const maxLength = parseInt(textarea.getAttribute('maxlength')) || 500;
            const span = counter.querySelector('span');
            
            span.textContent = currentLength;
            
            // Update counter styling based on remaining characters
            counter.classList.remove('warning', 'danger');
            const remaining = maxLength - currentLength;
            
            if (remaining <= 50 && remaining > 20) {
                counter.classList.add('warning');
            } else if (remaining <= 20) {
                counter.classList.add('danger');
            }
        }

        // Initialize auto-resize for all textareas
        document.addEventListener('DOMContentLoaded', function() {
            const textareas = document.querySelectorAll('textarea');
            
            // Map textarea IDs to their counter IDs
            const counterMap = {
                'pose': 'pose-counter',
                'outfit': 'outfit-counter',
                'referencias': 'referencias-counter',
                'descripcion': 'descripcion-counter'
            };
            
            textareas.forEach(textarea => {
                // Set initial height
                autoResizeTextarea(textarea);
                
                // Initialize character counter
                const counterId = counterMap[textarea.id];
                if (counterId) {
                    updateCharCounter(textarea, counterId);
                }
                
                // Auto-resize and update counter on input
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                    if (counterId) {
                        updateCharCounter(this, counterId);
                    }
                });
                
                // Auto-resize and update counter on paste (with slight delay to allow paste to complete)
                textarea.addEventListener('paste', function() {
                    setTimeout(() => {
                        autoResizeTextarea(this);
                        if (counterId) {
                            updateCharCounter(this, counterId);
                        }
                    }, 10);
                });
            });
        });

        // File storage for each input
        const fileStorage = {
            'pose-imagen': [],
            'outfit-imagen': [],
            'referencias-imagen': []
        };

        // Handle file input changes
        document.querySelectorAll('input[type="file"][multiple]').forEach(input => {
            input.addEventListener('change', function(e) {
                const maxFiles = parseInt(this.dataset.max) || 5;
                const files = Array.from(e.target.files);
                const inputId = this.id;
                const previewId = inputId.replace('-imagen', '-preview');
                
                // Check if adding these files would exceed the limit
                const currentFiles = fileStorage[inputId] || [];
                if (currentFiles.length + files.length > maxFiles) {
                    alert(`You can only upload up to ${maxFiles} images for this field.`);
                    this.value = '';
                    return;
                }

                // Add new files to storage
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        fileStorage[inputId].push(file);
                    }
                });

                // Update preview
                updateFilePreview(inputId, previewId);
                
                // Clear the input so the same file can be selected again if needed
                this.value = '';
            });
        });

        function updateFilePreview(inputId, previewId) {
            const preview = document.getElementById(previewId);
            const files = fileStorage[inputId];
            
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'file-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'file-preview-remove';
                    removeBtn.innerHTML = '×';
                    removeBtn.type = 'button';
                    removeBtn.onclick = function() {
                        fileStorage[inputId].splice(index, 1);
                        updateFilePreview(inputId, previewId);
                    };
                    
                    div.appendChild(img);
                    div.appendChild(removeBtn);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Upload image to Cloudinary
        async function uploadToCloudinary(file, category) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', `commission-requests/${category}`);
                formData.append('quality', 'auto:good');
                formData.append('fetch_format', 'auto');
                
                fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        reject(new Error(data.error.message || 'Upload failed'));
                    } else {
                        resolve({
                            url: data.secure_url,
                            publicUrl: data.url,
                            publicId: data.public_id,
                            width: data.width,
                            height: data.height,
                            format: data.format,
                            bytes: data.bytes
                        });
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }


        const form = document.getElementById('commissionsForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const submitBtn = document.getElementById('submitBtn');
        const popupOverlay = document.getElementById('popupOverlay');
        const popupContent = document.getElementById('popupContent');
        const popupIcon = document.getElementById('popupIcon');
        const popupTitle = document.getElementById('popupTitle');
        const popupMessage = document.getElementById('popupMessage');

        // Function to show popup
        function showPopup(type, title, message) {
            // Set popup content
            popupTitle.textContent = title;
            popupMessage.textContent = message;
            
            // Set icon based on type
            if (type === 'success') {
                popupIcon.textContent = '✓';
                popupContent.className = 'popup-content popup-success';
            } else {
                popupIcon.textContent = '✕';
                popupContent.className = 'popup-content popup-error';
            }
            
            // Show popup
            popupOverlay.classList.add('show');
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                popupOverlay.classList.remove('show');
            }, 4000);
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // Disable submit button
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<span class="loading"></span>Sending...';

            // Hide previous messages
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');

            try {
                // Check if Cloudinary config is loaded
                if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                    // Try to load config one more time
                    await loadCloudinaryConfig();
                    
                    if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
                        throw new Error('Cloudinary configuration not available. Please configure CLOUDINARY_CLOUD_NAME and CLOUDINARY_UPLOAD_PRESET in Vercel environment variables.');
                    }
                }
                
                // Upload all images to Cloudinary first
                submitBtn.innerHTML = '<span class="loading"></span>Uploading images...';
                
                const imageUrls = {
                    'pose-imagen': [],
                    'outfit-imagen': [],
                    'referencias-imagen': []
                };
                
                // Upload images by category
                const categoryMap = {
                    'pose-imagen': 'pose',
                    'outfit-imagen': 'outfit',
                    'referencias-imagen': 'referencias'
                };
                
                // Upload all images
                for (const [fieldName, files] of Object.entries(fileStorage)) {
                    if (files.length > 0) {
                        const category = categoryMap[fieldName] || 'other';
                        for (const file of files) {
                            try {
                                const uploadResult = await uploadToCloudinary(file, category);
                                imageUrls[fieldName].push(uploadResult);
                            } catch (uploadError) {
                                console.error(`Error uploading ${file.name}:`, uploadError);
                                throw new Error(`Failed to upload ${file.name}: ${uploadError.message}`);
                            }
                        }
                    }
                }
                
                // Update button text
                submitBtn.innerHTML = '<span class="loading"></span>Sending email...';
                
                // Create JSON payload with image URLs
                const payload = {
                    nombre: document.getElementById('nombre').value,
                    contactType: document.getElementById('contactType').value,
                    contactValue: document.getElementById('contactValue').value,
                    tipo: document.getElementById('tipo').value,
                    pose: document.getElementById('pose').value,
                    outfit: document.getElementById('outfit').value,
                    referencias: document.getElementById('referencias').value,
                    descripcion: document.getElementById('descripcion').value,
                    images: {
                        'pose-imagen': imageUrls['pose-imagen'],
                        'outfit-imagen': imageUrls['outfit-imagen'],
                        'referencias-imagen': imageUrls['referencias-imagen']
                    }
                };

                // Send JSON payload with image URLs
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // Clone response to read it multiple times if needed
                const responseClone = response.clone();
                let result;
                
                try {
                    // Try to parse as JSON first
                    result = await response.json();
                } catch (jsonError) {
                    // If JSON parsing fails, read as text
                    const text = await responseClone.text();
                    console.error('JSON parse error. Response text:', text.substring(0, 200));
                    
                    // Try to extract error message from HTML/text
                    if (text.includes('Request Entity Too Large') || text.includes('413')) {
                        throw new Error('File size too large. Please reduce image sizes or send fewer images.');
                    } else if (text.includes('Request')) {
                        throw new Error('Request error. Please try again with smaller files.');
                    } else {
                        throw new Error('Server error. Please try again.');
                    }
                }

                if (response.ok) {
                    // Show success popup
                    showPopup('success', '¡Éxito!', 'Tu solicitud ha sido enviada correctamente');
                    
                    // Show inline success message as well
                    successMessage.classList.add('show');
                    
                    // Clear form
                    form.reset();
                    
                    // Clear file storage and previews
                    Object.keys(fileStorage).forEach(key => {
                        fileStorage[key] = [];
                        const previewId = key.replace('-imagen', '-preview');
                        document.getElementById(previewId).innerHTML = '';
                    });

                    // Hide inline message after 5 seconds
                    setTimeout(() => {
                        successMessage.classList.remove('show');
                    }, 3000);
                } else {
                    throw new Error(result.error || result.details || 'Error sending form');
                }
            } catch (error) {
                console.error('Error:', error);
                
                // Show error popup
                showPopup('error', 'Error', error.message || 'Error al enviar el formulario. Por favor, intenta de nuevo.');
                
                // Show inline error message as well
                errorMessage.textContent = error.message || 'Error sending the form. Please try again.';
                errorMessage.classList.add('show');
                
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 5000);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Clear file storage on reset
        form.addEventListener('reset', function() {
            Object.keys(fileStorage).forEach(key => {
                fileStorage[key] = [];
                const previewId = key.replace('-imagen', '-preview');
                document.getElementById(previewId).innerHTML = '';
            });
            
            // Reset textarea heights to minimum and character counters
            const textareas = document.querySelectorAll('textarea');
            const counterMap = {
                'pose': 'pose-counter',
                'outfit': 'outfit-counter',
                'referencias': 'referencias-counter',
                'descripcion': 'descripcion-counter'
            };
            
            textareas.forEach(textarea => {
                textarea.style.height = '90px'; // Reset to min-height
                const counterId = counterMap[textarea.id];
                if (counterId) {
                    setTimeout(() => {
                        updateCharCounter(textarea, counterId);
                    }, 10);
                }
            });
        });
    </script>
</body>
</html>
